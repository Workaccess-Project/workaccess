<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Workaccess ‚Äì TODO</title>
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div id="wa-nav"></div>

      <div class="section">
        <h1 style="font-size:18px;">TODO</h1>
        <div class="small">
          Klik na ≈ô√°dek = v√Ωbƒõr. Checkbox = hotovo (a z√°rove≈à vybere).
          Hotov√© se ≈ôad√≠ dol≈Ø. Dvojklik = editace.
        </div>
      </div>

      <div class="section" style="display:grid; grid-template-columns:1fr auto; gap:10px;">
        <div style="display:flex; gap:10px; align-items:center;">
          <input id="newText" type="text" placeholder="Nov√Ω √∫kol‚Ä¶ (Enter p≈ôid√°)" autocomplete="off" />
          <button class="waBtn--primary" id="btnAdd">P≈ôidat</button>
        </div>
        <div style="display:flex; gap:10px; justify-content:flex-end; align-items:center; flex-wrap:wrap;">
          <button id="btnReload" title="Naƒç√≠st z backendu">Naƒç√≠st</button>
          <button class="waBtn--danger" id="btnDeleteSelected" disabled>Smazat vybranou</button>
          <button class="waBtn--danger" id="btnClearDone" title="Ctrl+Enter / Cmd+Enter">Smazat hotov√©</button>
        </div>
      </div>

      <div class="section" style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:center;">
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <span class="pill" id="countAll">Celkem: 0</span>
          <span class="pill" id="countDone">Hotovo: 0</span>
          <span class="pill" id="countLeft">Zb√Ωv√°: 0</span>
        </div>

        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button data-filter="all" aria-pressed="true">V≈°e</button>
          <button data-filter="active" aria-pressed="false">Aktivn√≠</button>
          <button data-filter="done" aria-pressed="false">Hotov√©</button>
        </div>
      </div>

      <ul id="list" aria-label="Seznam √∫kol≈Ø"></ul>
      <div class="section small" id="empty" style="display:none; text-align:center;">
        Zat√≠m tu nic nen√≠. P≈ôidej prvn√≠ √∫kol üôÇ
      </div>

      <div class="section small" style="border-top:1px solid var(--border);">
        Zkratka: <code>Ctrl</code>+<code>Enter</code> / <code>Cmd</code>+<code>Enter</code> = Smazat hotov√©
      </div>
    </div>
  </div>

  <script src="./js/wa_nav.js"></script>
  <script src="./js/api.js"></script>
  <script>
    WA_NAV.renderNav("todo");

    const LS_SELECTED = "workaccess.todo.selectedId";

    let ME = null;
    let items = [];
    let filter = "all";
    let selectedId = localStorage.getItem(LS_SELECTED);
    let editingId = null;

    const elList = document.getElementById("list");
    const elEmpty = document.getElementById("empty");
    const elNewText = document.getElementById("newText");
    const elBtnAdd = document.getElementById("btnAdd");
    const elBtnReload = document.getElementById("btnReload");
    const elBtnClearDone = document.getElementById("btnClearDone");
    const elBtnDeleteSelected = document.getElementById("btnDeleteSelected");
    const elCountAll = document.getElementById("countAll");
    const elCountDone = document.getElementById("countDone");
    const elCountLeft = document.getElementById("countLeft");
    const elFiltersWrap = document.querySelector('[aria-label="Seznam √∫kol≈Ø"]').previousElementSibling;

    function normalizeText(s){ return (s ?? "").toString().trim(); }
    function getItemText(item){ return item?.text ?? item?.title ?? item?.name ?? ""; }
    function isEditingNow(){ return editingId !== null; }

    function persistSelected(){
      if (selectedId == null) localStorage.removeItem(LS_SELECTED);
      else localStorage.setItem(LS_SELECTED, String(selectedId));
    }

    function sortItems(arr){
      return [...arr].sort((a,b) => {
        const ad = !!a.done, bd = !!b.done;
        if (ad !== bd) return ad ? 1 : -1;
        return String(a.id).localeCompare(String(b.id));
      });
    }
    function applyFilter(arr){
      if (filter === "active") return arr.filter(x => !x.done);
      if (filter === "done") return arr.filter(x => x.done);
      return arr;
    }

    function updateCounts(){
      const all = items.length;
      const done = items.filter(x => x.done).length;
      const left = all - done;

      elCountAll.textContent = `Celkem: ${all}`;
      elCountDone.textContent = `Hotovo: ${done}`;
      elCountLeft.textContent = `Zb√Ωv√°: ${left}`;

      // RBAC z backendu (pokud existuje)
      const perms = ME?.perms || null;

      const canAdd = perms ? !!perms.canAdd : true;
      const canDelete = perms ? !!perms.canDelete : true;
      const canClearDone = perms ? !!perms.canClearDone : true;

      elNewText.disabled = !canAdd;
      elBtnAdd.disabled = !canAdd;

      elBtnDeleteSelected.disabled = !canDelete || (selectedId == null);
      elBtnClearDone.disabled = !canClearDone || (done === 0);
    }

    function clearSelectedClass(){
      for (const other of elList.querySelectorAll(".todoRow.selected")) other.classList.remove("selected");
    }

    function applySelection(){
      clearSelectedClass();
      if (selectedId == null) { updateCounts(); return; }
      const el = elList.querySelector(`.todoRow[data-id="${CSS.escape(String(selectedId))}"]`);
      if (el) el.classList.add("selected");
      updateCounts();
    }

    function setSelectedById(id){
      selectedId = (id == null) ? null : String(id);
      persistSelected();
      applySelection();
    }

    function render(){
      updateCounts();

      const sorted = sortItems(items);
      const visible = applyFilter(sorted);

      elList.innerHTML = "";
      elEmpty.style.display = (items.length === 0) ? "block" : "none";

      for (const item of visible){
        const idStr = String(item.id);

        const li = document.createElement("li");
        li.className = "todoRow" + (item.done ? " done" : "");
        li.dataset.id = idStr;

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = !!item.done;

        cb.addEventListener("click", (e) => {
          e.stopPropagation();
          if (isEditingNow()) return;
          setSelectedById(idStr);
        });

        cb.addEventListener("change", async () => {
          if (isEditingNow()) return;
          setSelectedById(idStr);

          cb.disabled = true;
          try {
            await WA_API.toggleItem(item.id);
            await reload(true, idStr);
          } catch (e) {
            alert("Chyba p≈ôi p≈ôepnut√≠ hotovo: " + (e?.message || e));
            cb.disabled = false;
            cb.checked = !!item.done;
          }
        });

        const titleWrap = document.createElement("div");
        titleWrap.style.minWidth = "0";

        if (editingId === idStr){
          const inp = document.createElement("input");
          inp.value = getItemText(item);

          setTimeout(() => {
            inp.focus();
            inp.setSelectionRange(inp.value.length, inp.value.length);
          }, 0);

          const original = getItemText(item);
          const cancel = () => { editingId = null; render(); };

          const save = async () => {
            const next = normalizeText(inp.value);
            if (!next || next === normalizeText(original)) { cancel(); return; }
            try {
              await WA_API.updateItemText(item.id, next);
              editingId = null;
              await reload(true, idStr);
            } catch (e) {
              alert("Chyba p≈ôi ulo≈æen√≠ textu: " + (e?.message || e));
            }
          };

          inp.addEventListener("keydown", (e) => {
            if (e.key === "Enter") { e.preventDefault(); save(); }
            if (e.key === "Escape") { e.preventDefault(); cancel(); }
            e.stopPropagation();
          });
          inp.addEventListener("blur", () => cancel());

          titleWrap.appendChild(inp);
        } else {
          const title = document.createElement("div");
          title.className = "todoTitle";
          title.textContent = getItemText(item);
          titleWrap.appendChild(title);

          titleWrap.addEventListener("dblclick", (e) => {
            e.stopPropagation();
            if (isEditingNow()) return;
            setSelectedById(idStr);
            editingId = idStr;
            render();
          });
        }

        const actions = document.createElement("div");
        actions.style.display = "flex";
        actions.style.gap = "8px";
        actions.style.alignItems = "center";

        const btnDel = document.createElement("button");
        btnDel.className = "waIconBtn waBtn--danger";
        btnDel.textContent = "‚úï";
        btnDel.title = "Smazat";

        btnDel.addEventListener("click", async (e) => {
          e.stopPropagation();
          if (!confirm("Smazat tuto polo≈æku?")) return;
          try {
            await WA_API.deleteItem(item.id);
            if (String(selectedId) === idStr) setSelectedById(null);
            await reload(true);
          } catch (err) {
            alert("Chyba p≈ôi maz√°n√≠ polo≈æky: " + (err?.message || err));
          }
        });

        actions.appendChild(btnDel);

        li.addEventListener("click", () => {
          if (isEditingNow()) return;
          setSelectedById(idStr);
        });

        li.appendChild(cb);
        li.appendChild(titleWrap);
        li.appendChild(actions);
        elList.appendChild(li);
      }

      requestAnimationFrame(applySelection);
    }

    async function reload(keepSelection, forceSelectedId){
      const prev = forceSelectedId != null
        ? String(forceSelectedId)
        : (keepSelection ? (selectedId ?? localStorage.getItem(LS_SELECTED)) : null);

      selectedId = prev != null ? String(prev) : null;
      persistSelected();

      items = await WA_API.getItems();
      if (!Array.isArray(items)) items = [];
      render();
    }

    async function addFromInput(){
      const text = normalizeText(elNewText.value);
      if (!text) return;
      try {
        await WA_API.addItem(text);
        elNewText.value = "";
        await reload(true);
      } catch (e) {
        alert("Chyba p≈ôi p≈ôid√°n√≠ √∫kolu: " + (e?.message || e));
      }
    }

    async function clearDone(){
      const doneCount = items.filter(x => x.done).length;
      if (!doneCount) return;
      if (!confirm("Smazat v≈°echny hotov√© polo≈æky?")) return;
      try {
        await WA_API.deleteDone();
        setSelectedById(null);
        await reload(false);
      } catch (e) {
        alert("Chyba p≈ôi maz√°n√≠ hotov√Ωch: " + (e?.message || e));
      }
    }

    async function deleteSelected(){
      if (selectedId == null) return;

      const item = items.find(x => String(x.id) === String(selectedId));
      if (!item) { setSelectedById(null); render(); return; }

      const label = normalizeText(getItemText(item));
      const msg = label ? `Smazat polo≈æku:\n‚Äû${label}‚Äú ?` : "Smazat tuto polo≈æku?";
      if (!confirm(msg)) return;

      try {
        await WA_API.deleteItem(item.id);
        setSelectedById(null);
        await reload(false);
      } catch (e) {
        alert("Chyba p≈ôi maz√°n√≠ polo≈æky: " + (e?.message || e));
      }
    }

    // events
    elBtnAdd.addEventListener("click", addFromInput);
    elNewText.addEventListener("keydown", (e) => { if (e.key === "Enter") addFromInput(); });
    elBtnReload.addEventListener("click", () => reload(true));
    elBtnClearDone.addEventListener("click", clearDone);
    elBtnDeleteSelected.addEventListener("click", deleteSelected);

    // filtry (buttons v sekci ‚Äì vyhled√°me je jednodu≈°e p≈ôes data-filter v cel√© kartƒõ)
    document.querySelectorAll('button[data-filter]').forEach(btn => {
      btn.addEventListener("click", () => {
        filter = btn.dataset.filter;
        document.querySelectorAll('button[data-filter]').forEach(b => {
          b.setAttribute("aria-pressed", (b === btn) ? "true" : "false");
        });
        render();
      });
    });

    document.addEventListener("keydown", async (e) => {
      if (isEditingNow()) return;
      if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
        e.preventDefault();
        await clearDone();
      }
    });

    // init
    (async () => {
      try {
        ME = await WA_API.getMe();
        await reload(false);
      } catch (e) {
        console.error(e);
        alert("Nepoda≈ôilo se inicializovat aplikaci. Je backend spu≈°tƒõn√Ω na http://localhost:3000 ?");
      }
    })();
  </script>
</body>
</html>
