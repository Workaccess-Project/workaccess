<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Workaccess – Zaměstnanci</title>
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div id="wa-nav"></div>

      <div class="section">
        <h1 style="font-size:18px; margin:0;">Zaměstnanci</h1>
        <div class="small">Seznam je z backendu: <code>/api/employees</code></div>
      </div>

      <div class="section" style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;">
        <input id="q" type="text" placeholder="Hledat (jméno, email, oddělení)…" style="flex:1; min-width:260px;" autocomplete="off" />
        <button class="waBtn--primary" id="btnLoad">Načíst</button>
      </div>

      <div class="section small" id="meta"></div>

      <div class="section">
        <table class="waTable" style="width:100%;">
          <thead>
            <tr>
              <th style="width:25%;">Jméno</th>
              <th style="width:25%;">Email</th>
              <th style="width:20%;">Oddělení</th>
              <th style="width:20%;">Pozice</th>
              <th style="width:10%;">Stav</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
        <div class="small" id="empty" style="display:none; text-align:center; padding:14px;">
          Nic nenalezeno.
        </div>
      </div>
    </div>
  </div>

  <!-- DŮLEŽITÉ pořadí: config -> nav -> api -->
  <script src="./js/wa_config.js"></script>
  <script src="./js/wa_nav.js"></script>
  <script src="./api.js"></script>

  <script>
    WA_NAV.renderNav("employees");

    const elQ = document.getElementById("q");
    const elBtnLoad = document.getElementById("btnLoad");
    const elMeta = document.getElementById("meta");
    const elBody = document.getElementById("tbody");
    const elEmpty = document.getElementById("empty");

    function esc(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function roleLabel(roleKey) {
      const map = { hr: "HR", manager: "Manažer", security: "Bezpečnost", external: "Externista" };
      return map[roleKey] || roleKey;
    }

    function normalize(s) {
      return String(s ?? "").toLowerCase().trim();
    }

    function matchEmployee(emp, q) {
      if (!q) return true;
      const hay = [
        emp?.name,
        emp?.email,
        emp?.department,
        emp?.team,
        emp?.position,
        emp?.role,
      ].map(normalize).join(" | ");
      return hay.includes(q);
    }

    function renderRows(list) {
      elBody.innerHTML = "";
      elEmpty.style.display = list.length ? "none" : "block";

      for (const e of list) {
        const tr = document.createElement("tr");

        const tdName = document.createElement("td");
        tdName.textContent = e?.name ?? "—";

        const tdEmail = document.createElement("td");
        tdEmail.textContent = e?.email ?? "—";

        const tdDept = document.createElement("td");
        tdDept.textContent = e?.department ?? e?.team ?? "—";

        const tdPos = document.createElement("td");
        tdPos.textContent = e?.position ?? "—";

        const tdState = document.createElement("td");
        tdState.textContent = e?.status ?? "—";

        tr.appendChild(tdName);
        tr.appendChild(tdEmail);
        tr.appendChild(tdDept);
        tr.appendChild(tdPos);
        tr.appendChild(tdState);

        elBody.appendChild(tr);
      }
    }

    async function load() {
      elBtnLoad.disabled = true;
      try {
        const me = await WA_API.getMe();
        const role = me?.role || WA_NAV.getRole();
        const all = await WA_API.getEmployees();
        const arr = Array.isArray(all) ? all : [];
        const q = normalize(elQ.value);

        const filtered = arr.filter((x) => matchEmployee(x, q));

        elMeta.textContent = `Role: ${roleLabel(role)} • Záznamů: ${filtered.length}`;
        renderRows(filtered);
      } catch (e) {
        console.error(e);
        alert("Chyba při načtení zaměstnanců: " + (e?.message || e));
      } finally {
        elBtnLoad.disabled = false;
      }
    }

    elBtnLoad.addEventListener("click", load);
    elQ.addEventListener("keydown", (e) => {
      if (e.key === "Enter") load();
    });

    // init
    load();
  </script>
</body>
</html>
