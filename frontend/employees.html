<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Workaccess – Zaměstnanci</title>

  <style>
    :root{
      --bg:#0b1020;
      --muted:#8aa0c6;
      --text:#e8eeff;
      --accent:#6ea8fe;
      --danger:#ff6b6b;
      --warn:#ffd166;
      --ok:#63e6be;
      --border:rgba(255,255,255,.08);
      --shadow:0 10px 25px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 600px at 20% 0%, rgba(110,168,254,.25), transparent 60%),
                  radial-gradient(1200px 600px at 80% 20%, rgba(99,230,190,.18), transparent 60%),
                  var(--bg);
      color:var(--text);
      padding:24px;
    }
    .wrap{max-width:1100px;margin:0 auto}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow:var(--shadow);
      overflow:hidden;
      position:relative;
    }
    header{
      padding:18px 18px 12px;
      border-bottom:1px solid var(--border);
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
    }
    h1{font-size:18px;margin:0;letter-spacing:.2px}
    .hint{font-size:12px;color:var(--muted);margin:6px 0 0;line-height:1.35}

    .nav{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .pill{
      padding:6px 10px;border-radius:999px;border:1px solid var(--border);
      background:rgba(0,0,0,.14);color:var(--muted);font-size:12px;
    }
    a.navlink{
      color:var(--muted);text-decoration:none;padding:6px 10px;border-radius:999px;border:1px solid transparent;
    }
    a.navlink.active{
      color:var(--text);border-color:rgba(110,168,254,.35);background:rgba(110,168,254,.16);
    }

    button{
      padding:10px 12px;border-radius:12px;border:1px solid var(--border);
      background:rgba(255,255,255,.06);color:var(--text);cursor:pointer;user-select:none;white-space:nowrap;
    }
    button:hover{border-color:rgba(255,255,255,.18)}
    button.primary{background:rgba(110,168,254,.18);border-color:rgba(110,168,254,.25)}
    button:disabled{opacity:.45;cursor:not-allowed}

    .toolbar{
      padding:14px 18px;
      display:grid;
      grid-template-columns: 1fr 220px 170px auto;
      gap:10px;
      border-bottom:1px solid var(--border);
      align-items:end;
    }
    input[type="text"], input[type="date"], input[type="number"], select{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
    }
    input::placeholder{color:rgba(232,238,255,.45)}
    .toolbar .miniLabel{
      font-size:11px;
      color:var(--muted);
      margin-bottom:6px;
    }
    @media (max-width: 980px){
      .toolbar{grid-template-columns:1fr 1fr; }
      .toolbar button{grid-column:1 / -1}
    }

    .statusLine{padding:0 18px 14px;color:var(--muted);font-size:12px;}

    table{width:100%;border-collapse:collapse;font-size:13px;}
    thead th{
      text-align:left;padding:10px 18px;color:var(--muted);font-weight:600;
      border-top:1px solid var(--border);border-bottom:1px solid var(--border);background:rgba(0,0,0,.10);
    }
    tbody td{padding:10px 18px;border-bottom:1px solid var(--border);color:var(--text);vertical-align:middle;}
    tbody tr{cursor:pointer;}
    tbody tr:hover{background:rgba(110,168,254,.10);}

    .okBadge{display:inline-flex;align-items:center;gap:6px;color:var(--muted);font-size:12px;padding-right:18px;}
    .okDot{
      width:10px;height:10px;border-radius:999px;background:rgba(99,230,190,.55);
      box-shadow:0 0 0 3px rgba(99,230,190,.12);display:inline-block;
    }

    /* status pill */
    .st{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;display:inline-block;
      box-shadow:0 0 0 3px rgba(255,255,255,.06);
    }
    .dot.ok{background:rgba(99,230,190,.65); box-shadow:0 0 0 3px rgba(99,230,190,.12);}
    .dot.warn{background:rgba(255,209,102,.75); box-shadow:0 0 0 3px rgba(255,209,102,.12);}
    .dot.bad{background:rgba(255,107,107,.75); box-shadow:0 0 0 3px rgba(255,107,107,.12);}

    /* Modal */
    .modalBack{
      position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;
      padding:18px;z-index:9999;
    }
    .modal{
      width:min(980px, 100%);
      background:linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.05));
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      box-shadow:0 20px 50px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modalHead{
      padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.10);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .modalHead strong{font-size:14px}
    .iconbtn{width:38px;height:34px;display:inline-grid;place-items:center;padding:0;}
    .modalBody{padding:14px 16px}
    .grid{display:grid;grid-template-columns: 1fr 1fr;gap:12px;}
    .field{
      border:1px solid rgba(255,255,255,.10);border-radius:14px;padding:12px 12px;
      background:rgba(0,0,0,.10);min-width:0;
    }
    .field .label{font-size:11px;color:var(--muted);margin-bottom:6px;}
    .field .value{font-size:13px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

    .trainingsBox{
      margin-top:12px;border:1px solid rgba(255,255,255,.10);border-radius:14px;background:rgba(0,0,0,.10);overflow:hidden;
    }
    .trainingsHead{
      padding:12px 12px;display:flex;align-items:center;justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.10);color:var(--muted);font-size:12px;
    }
    .trainingItem{padding:12px 12px;border-bottom:1px solid rgba(255,255,255,.08);}
    .trainingItem:last-child{border-bottom:0}
    .trainingTitle{
      font-size:13px;color:var(--text);display:flex;gap:10px;align-items:center;flex-wrap:wrap;
    }
    .tag{
      font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.12);
      color:var(--muted);background:rgba(0,0,0,.12);
    }
    .trainingDates{margin-top:6px;font-size:12px;color:var(--muted);}

    .rowBtns{margin-left:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    .btnSmall{
      padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
    }
    .btnDanger{background:rgba(255,107,107,.12);}
    .btnQuick{background:rgba(110,168,254,.14);border-color:rgba(110,168,254,.25);}
    .btnQuick2{background:rgba(99,230,190,.12);border-color:rgba(99,230,190,.25);}

    .editBox{
      margin-top:10px;
      border:1px solid rgba(255,255,255,.10);
      border-radius:12px;
      padding:10px;
      background:rgba(0,0,0,.10);
      display:grid;
      grid-template-columns: 1fr 180px 180px auto auto;
      gap:10px;
      align-items:end;
    }
    .editBox .miniLabel{font-size:11px;color:var(--muted);margin-bottom:6px;}
    .editBox .col{min-width:0;}
    @media (max-width: 820px){
      .grid{grid-template-columns:1fr}
      .editBox{grid-template-columns: 1fr 1fr; }
      .editBox button{grid-column:1 / -1}
    }

    .addTrainingBox{
      margin-top:12px;border:1px solid rgba(110,168,254,.22);border-radius:14px;background:rgba(110,168,254,.06);overflow:hidden;
    }
    .addTrainingHead{
      padding:12px 12px;display:flex;align-items:center;justify-content:space-between;gap:10px;border-bottom:1px solid rgba(255,255,255,.10);
    }
    .addTrainingForm{
      padding:12px 12px;display:grid;grid-template-columns: 1fr 180px 180px auto;gap:10px;align-items:end;
    }
    .addTrainingForm .help{grid-column: 1 / -1;font-size:12px;color:var(--muted);margin:0;}
    @media (max-width: 820px){
      .addTrainingForm{grid-template-columns: 1fr 1fr; }
      .addTrainingForm button{grid-column:1 / -1}
    }

    .modalFoot{padding:12px 16px 16px;display:flex;justify-content:flex-end;gap:10px;border-top:1px solid rgba(255,255,255,.10);}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <header>
        <div>
          <div class="nav">
            <span class="pill" style="color:var(--text)">WORKACCESS</span>
            <a class="navlink" href="./dashboard.html">Dashboard</a>
            <a class="navlink active" href="./employees.html">Zaměstnanci</a>
            <a class="navlink" href="./index.html">TODO</a>
          </div>
          <h1 style="margin-top:10px">Zaměstnanci</h1>
          <div class="hint">Seznam je z backendu: <span class="pill">/api/employees</span></div>
        </div>

        <div style="display:flex; flex-direction:column; align-items:flex-end; gap:8px;">
          <div class="pill">Role: <span id="roleLabel" style="color:var(--text)">—</span></div>
          <button id="btnChangeRole">Změnit roli</button>
        </div>
      </header>

      <div class="toolbar">
        <div>
          <div class="miniLabel">Hledat</div>
          <input id="q" type="text" placeholder="Hledat (jméno, email, oddělení)..." autocomplete="off" />
        </div>

        <div>
          <div class="miniLabel">Filtr</div>
          <select id="filterMode">
            <option value="all">Všichni</option>
            <option value="expired">Propadlé</option>
            <option value="expiring">Končí brzy</option>
            <option value="ok">OK</option>
          </select>
        </div>

        <div>
          <div class="miniLabel">Končí brzy (dní)</div>
          <input id="expDays" type="number" min="0" value="30" />
        </div>

        <button class="primary" id="btnLoad">Načíst</button>
      </div>

      <div class="statusLine">
        <span id="statusText">—</span>
        <span style="float:right" class="okBadge" id="okBadge" hidden><span class="okDot"></span>Hotovo</span>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:22%">Jméno</th>
            <th style="width:28%">Email</th>
            <th style="width:22%">Oddělení</th>
            <th style="width:18%">Pozice</th>
            <th>Stav</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>

  <!-- Modal: Detail -->
  <div class="modalBack" id="detailBack" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="modalHead">
        <strong id="detailTitle">Detail</strong>
        <button class="iconbtn" id="btnDetailClose" title="Zavřít">✕</button>
      </div>

      <div class="modalBody">
        <div class="grid">
          <div class="field">
            <div class="label">Jméno</div>
            <div class="value" id="dName">—</div>
          </div>
          <div class="field">
            <div class="label">Email</div>
            <div class="value" id="dEmail">—</div>
          </div>
          <div class="field">
            <div class="label">Oddělení / Firma</div>
            <div class="value" id="dCompany">—</div>
          </div>
          <div class="field">
            <div class="label">Role / Pozice</div>
            <div class="value" id="dPosition">—</div>
          </div>
          <div class="field">
            <div class="label">ID</div>
            <div class="value" id="dId">—</div>
          </div>
          <div class="field">
            <div class="label">Aktualizováno</div>
            <div class="value" id="dUpdatedAt">—</div>
          </div>
        </div>

        <div class="trainingsBox" style="margin-top:12px">
          <div class="trainingsHead">
            <strong style="color:var(--text); font-weight:700">Školení</strong>
            <span class="tag" id="dTrainCount">0</span>
          </div>
          <div id="dTrainings"></div>
        </div>

        <!-- Add training -->
        <div class="addTrainingBox" id="addTrainingBox" hidden>
          <div class="addTrainingHead">
            <strong style="color:var(--text); font-weight:700">+ Přidat školení</strong>
            <span class="tag">POST /api/employees/:id/trainings</span>
          </div>

          <div class="addTrainingForm">
            <p class="help">Vyplň název a platnost. Po uložení se detail znovu načte.</p>

            <div>
              <div class="label" style="margin-bottom:6px;color:var(--muted);font-size:11px;">Název školení</div>
              <input id="tName" type="text" placeholder="Např. BOZP" />
            </div>

            <div>
              <div class="label" style="margin-bottom:6px;color:var(--muted);font-size:11px;">Platí od</div>
              <input id="tFrom" type="date" />
            </div>

            <div>
              <div class="label" style="margin-bottom:6px;color:var(--muted);font-size:11px;">Platí do</div>
              <input id="tTo" type="date" />
            </div>

            <button class="primary" id="btnSaveTraining">Uložit školení</button>
          </div>
        </div>
      </div>

      <div class="modalFoot">
        <button id="btnDetailClose2">Zavřít</button>
      </div>
    </div>
  </div>

  <!-- Modal: Role -->
  <div class="modalBack" id="roleBack" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" style="width:min(820px,100%)">
      <div class="modalHead">
        <strong>Vyber roli (DEMO)</strong>
        <button class="iconbtn" id="btnRoleClose" title="Zavřít">✕</button>
      </div>
      <div class="modalBody">
        <div class="hint" style="margin:0 0 10px">
          Demo přihlášení. Role se ukládá do localStorage a posílá se do backendu v hlavičce <span class="pill">x-role</span>.
        </div>
        <select id="roleSelect" style="width:100%; padding:12px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.14); background:rgba(0,0,0,.22); color:var(--text); outline:none; font-size:14px;">
          <option value="hr">HR</option>
          <option value="security">Bezpečnost</option>
          <option value="manager">Manažer</option>
          <option value="external">Externista</option>
        </select>
      </div>
      <div class="modalFoot">
        <button id="btnRoleCancel">Zrušit</button>
        <button class="primary" id="btnRoleApply">Použít roli</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "http://localhost:3000/api/employees";

    const LS_ROLE = "workaccess.portal.role";
    const ROLE_LABELS = { hr:"HR", security:"Bezpečnost", manager:"Manažer", external:"Externista" };

    let role = localStorage.getItem(LS_ROLE) || "hr";

    let employees = [];
    let selectedEmployeeId = null;

    // edit state
    let editingTrainingId = null;
    let editDraft = { name: "", validFrom: "", validTo: "" };

    // UI
    const elRoleLabel = document.getElementById("roleLabel");
    const elBtnChangeRole = document.getElementById("btnChangeRole");
    const elQ = document.getElementById("q");
    const elFilterMode = document.getElementById("filterMode");
    const elExpDays = document.getElementById("expDays");
    const elBtnLoad = document.getElementById("btnLoad");
    const elRows = document.getElementById("rows");
    const elStatusText = document.getElementById("statusText");
    const elOkBadge = document.getElementById("okBadge");

    // Detail modal
    const detailBack = document.getElementById("detailBack");
    const btnDetailClose = document.getElementById("btnDetailClose");
    const btnDetailClose2 = document.getElementById("btnDetailClose2");
    const elDetailTitle = document.getElementById("detailTitle");

    const dName = document.getElementById("dName");
    const dEmail = document.getElementById("dEmail");
    const dCompany = document.getElementById("dCompany");
    const dPosition = document.getElementById("dPosition");
    const dId = document.getElementById("dId");
    const dUpdatedAt = document.getElementById("dUpdatedAt");
    const dTrainCount = document.getElementById("dTrainCount");
    const dTrainings = document.getElementById("dTrainings");

    const addTrainingBox = document.getElementById("addTrainingBox");
    const tName = document.getElementById("tName");
    const tFrom = document.getElementById("tFrom");
    const tTo = document.getElementById("tTo");
    const btnSaveTraining = document.getElementById("btnSaveTraining");

    // Role modal
    const roleBack = document.getElementById("roleBack");
    const roleSelect = document.getElementById("roleSelect");
    const btnRoleClose = document.getElementById("btnRoleClose");
    const btnRoleCancel = document.getElementById("btnRoleCancel");
    const btnRoleApply = document.getElementById("btnRoleApply");

    function headersWithRole() {
      return {
        "Content-Type": "application/json",
        "x-role": role
      };
    }

    function applyRoleUI() {
      elRoleLabel.textContent = ROLE_LABELS[role] || role;
    }

    function fmtDate(iso) {
      if (!iso) return "—";
      const d = new Date(iso);
      if (String(d) === "Invalid Date") return String(iso);
      return d.toLocaleString("cs-CZ");
    }

    function normalizeText(s) {
      return (s ?? "").toString().trim();
    }

    function displayName(e) {
      const n = normalizeText(e?.name);
      if (n) return n;
      const fn = normalizeText(e?.firstName);
      const ln = normalizeText(e?.lastName);
      const joined = [fn, ln].filter(Boolean).join(" ").trim();
      return joined || "—";
    }

    function canEditTraining() {
      return role === "hr" || role === "manager";
    }

    function isIsoDateOnly(s) {
      return /^\d{4}-\d{2}-\d{2}$/.test(String(s || ""));
    }

    function parseDateOnlyUtc(yyyyMmDd) {
      if (!isIsoDateOnly(yyyyMmDd)) return null;
      const [y, m, d] = yyyyMmDd.split("-").map(n => Number(n));
      const dt = new Date(Date.UTC(y, m - 1, d));
      return String(dt) === "Invalid Date" ? null : dt;
    }

    function todayUtcStart() {
      const n = new Date();
      return new Date(Date.UTC(n.getUTCFullYear(), n.getUTCMonth(), n.getUTCDate()));
    }

    function daysBetweenUtc(a, b) {
      const ms = b.getTime() - a.getTime();
      return Math.floor(ms / (1000 * 60 * 60 * 24));
    }

    function todayStrUtc() {
      const d = new Date();
      const yyyy = d.getUTCFullYear();
      const mm = String(d.getUTCMonth() + 1).padStart(2, "0");
      const dd = String(d.getUTCDate()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function addYearsToDateStr(yyyyMmDd, years) {
      if (!isIsoDateOnly(yyyyMmDd)) return null;
      const [y, m, d] = yyyyMmDd.split("-").map(n => Number(n));
      if (!y || !m || !d) return null;
      const dt2 = new Date(Date.UTC(y + years, m - 1, d));
      if (String(dt2) === "Invalid Date") return null;
      const yy = dt2.getUTCFullYear();
      const mm = String(dt2.getUTCMonth() + 1).padStart(2, "0");
      const dd = String(dt2.getUTCDate()).padStart(2, "0");
      return `${yy}-${mm}-${dd}`;
    }

    function trainingStatus(t, expiringDays) {
      const toDt = parseDateOnlyUtc(t?.validTo);
      if (!toDt) return { status: "unknown", daysLeft: null };

      const now = todayUtcStart();
      const dl = daysBetweenUtc(now, toDt);

      if (dl < 0) return { status: "expired", daysLeft: dl };
      if (dl <= expiringDays) return { status: "expiring", daysLeft: dl };
      return { status: "ok", daysLeft: dl };
    }

    function employeeStatus(emp, expiringDays) {
      const arr = Array.isArray(emp?.trainings) ? emp.trainings : [];
      let hasExpired = false;
      let hasExpiring = false;
      let bestDaysLeft = null;

      for (const t of arr) {
        const st = trainingStatus(t, expiringDays);
        if (st.status === "expired") hasExpired = true;
        else if (st.status === "expiring") hasExpiring = true;

        if (typeof st.daysLeft === "number") {
          if (bestDaysLeft == null) bestDaysLeft = st.daysLeft;
          else bestDaysLeft = Math.min(bestDaysLeft, st.daysLeft);
        }
      }

      if (hasExpired) return { status: "expired", label: "Propadlé", daysLeft: bestDaysLeft };
      if (hasExpiring) return { status: "expiring", label: `Končí brzy`, daysLeft: bestDaysLeft };
      return { status: "ok", label: "OK", daysLeft: bestDaysLeft };
    }

    async function apiList() {
      const res = await fetch(API_BASE, { headers: headersWithRole() });
      if (!res.ok) throw new Error(`GET /employees failed (${res.status})`);
      return await res.json();
    }

    async function apiDetail(id) {
      const res = await fetch(`${API_BASE}/${encodeURIComponent(id)}`, { headers: headersWithRole() });
      if (!res.ok) throw new Error(`GET /employees/:id failed (${res.status})`);
      return await res.json();
    }

    async function apiAddTraining(id, payload) {
      const res = await fetch(`${API_BASE}/${encodeURIComponent(id)}/trainings`, {
        method: "POST",
        headers: headersWithRole(),
        body: JSON.stringify(payload)
      });
      if (!res.ok) {
        const txt = await res.text().catch(() => "");
        throw new Error(`POST /trainings failed (${res.status}) ${txt}`);
      }
      return await res.json();
    }

    async function apiDeleteTraining(empId, trainingId) {
      const res = await fetch(`${API_BASE}/${encodeURIComponent(empId)}/trainings/${encodeURIComponent(trainingId)}`, {
        method: "DELETE",
        headers: headersWithRole(),
      });
      if (!res.ok) {
        const txt = await res.text().catch(() => "");
        throw new Error(`DELETE /trainings failed (${res.status}) ${txt}`);
      }
      return await res.json().catch(() => ({}));
    }

    async function apiUpdateTraining(empId, trainingId, payload) {
      const res = await fetch(`${API_BASE}/${encodeURIComponent(empId)}/trainings/${encodeURIComponent(trainingId)}`, {
        method: "PUT",
        headers: headersWithRole(),
        body: JSON.stringify(payload),
      });
      if (!res.ok) {
        const txt = await res.text().catch(() => "");
        throw new Error(`PUT /trainings failed (${res.status}) ${txt}`);
      }
      return await res.json().catch(() => ({}));
    }

    function startEditTraining(t) {
      editingTrainingId = t?.id || null;
      editDraft = {
        name: String(t?.name || ""),
        validFrom: String(t?.validFrom || ""),
        validTo: String(t?.validTo || "")
      };
      renderTrainings(lastDetailTrainings);
    }

    function cancelEditTraining() {
      editingTrainingId = null;
      editDraft = { name: "", validFrom: "", validTo: "" };
      renderTrainings(lastDetailTrainings);
    }

    async function saveEditTraining() {
      if (!selectedEmployeeId || !editingTrainingId) return;

      const name = normalizeText(editDraft.name);
      const validFrom = normalizeText(editDraft.validFrom);
      const validTo = normalizeText(editDraft.validTo);

      if (!name || !validFrom || !validTo) {
        alert("Vyplň název, platí od a platí do.");
        return;
      }
      if (validTo < validFrom) {
        alert("Datum 'platí do' musí být později než 'platí od'.");
        return;
      }

      try {
        await apiUpdateTraining(selectedEmployeeId, editingTrainingId, { name, validFrom, validTo });
        editingTrainingId = null;
        await openDetail(selectedEmployeeId);
      } catch (err) {
        console.error(err);
        alert("Nepodařilo se upravit školení: " + (err?.message || err));
      }
    }

    async function quickExtendOneYearFromOld(t) {
      if (!selectedEmployeeId) return;
      if (!canEditTraining()) return alert("Tvoje role nemůže upravovat školení.");

      const tid = t?.id;
      if (!tid) return alert("Školení nemá id (znovu načti seznam).");

      const oldTo = String(t?.validTo || "");
      const newTo = addYearsToDateStr(oldTo, 1);

      if (!newTo) return alert("Nejde prodloužit: 'Platí do' není YYYY-MM-DD.");

      const ok = confirm(`Prodloužit "${t?.name || "—"}"\nPlatí do: ${oldTo} → ${newTo}\n\nPokračovat?`);
      if (!ok) return;

      try {
        await apiUpdateTraining(selectedEmployeeId, tid, {
          name: String(t?.name || "—"),
          validFrom: String(t?.validFrom || ""),
          validTo: newTo
        });
        await openDetail(selectedEmployeeId);
      } catch (err) {
        console.error(err);
        alert("Nepodařilo se prodloužit školení: " + (err?.message || err));
      }
    }

    async function quickResetOneYearFromToday(t) {
      if (!selectedEmployeeId) return;
      if (!canEditTraining()) return alert("Tvoje role nemůže upravovat školení.");

      const tid = t?.id;
      if (!tid) return alert("Školení nemá id (znovu načti seznam).");

      const from = todayStrUtc();
      const to = addYearsToDateStr(from, 1);
      if (!to) return alert("Chyba výpočtu data.");

      const ok = confirm(`Nastavit od dneška +1 rok\n"${t?.name || "—"}"\nPlatí od: ${from}\nPlatí do: ${to}\n\nPokračovat?`);
      if (!ok) return;

      try {
        await apiUpdateTraining(selectedEmployeeId, tid, {
          name: String(t?.name || "—"),
          validFrom: from,
          validTo: to
        });
        await openDetail(selectedEmployeeId);
      } catch (err) {
        console.error(err);
        alert("Nepodařilo se nastavit od dneška: " + (err?.message || err));
      }
    }

    let lastDetailTrainings = [];

    function isTrainingValid(t) {
      const to = parseDateOnlyUtc(t?.validTo);
      if (!to) return false;
      return to.getTime() >= todayUtcStart().getTime();
    }

    function renderTrainings(trainings) {
      const arr = Array.isArray(trainings) ? trainings : [];
      lastDetailTrainings = arr;

      dTrainCount.textContent = String(arr.length);
      dTrainings.innerHTML = "";

      if (arr.length === 0) {
        const div = document.createElement("div");
        div.className = "trainingItem";
        div.style.color = "rgba(232,238,255,.55)";
        div.textContent = "Žádná školení.";
        dTrainings.appendChild(div);
        return;
      }

      for (const t of arr) {
        const item = document.createElement("div");
        item.className = "trainingItem";

        const title = document.createElement("div");
        title.className = "trainingTitle";

        const nameSpan = document.createElement("span");
        nameSpan.textContent = t?.name || "—";
        title.appendChild(nameSpan);

        const badge = document.createElement("span");
        badge.className = "tag";
        badge.textContent = isTrainingValid(t) ? "platné" : "propadlé";
        title.appendChild(badge);

        if (canEditTraining()) {
          const btns = document.createElement("div");
          btns.className = "rowBtns";

          const plusBtn = document.createElement("button");
          plusBtn.className = "btnSmall btnQuick";
          plusBtn.textContent = "+1 rok";
          plusBtn.title = "Prodlouží 'Platí do' o 1 rok (od původního data)";
          plusBtn.addEventListener("click", async (e) => {
            e.stopPropagation();
            await quickExtendOneYearFromOld(t);
          });

          const resetBtn = document.createElement("button");
          resetBtn.className = "btnSmall btnQuick2";
          resetBtn.textContent = "Od dneška +1 rok";
          resetBtn.title = "Nastaví validFrom = dnes a validTo = dnes + 1 rok";
          resetBtn.addEventListener("click", async (e) => {
            e.stopPropagation();
            await quickResetOneYearFromToday(t);
          });

          const editBtn = document.createElement("button");
          editBtn.className = "btnSmall";
          editBtn.textContent = "Upravit";
          editBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            if (!t?.id) return alert("Školení nemá id (znovu načti seznam).");
            startEditTraining(t);
          });

          const delBtn = document.createElement("button");
          delBtn.className = "btnSmall btnDanger";
          delBtn.textContent = "Smazat";
          delBtn.addEventListener("click", async (e) => {
            e.stopPropagation();
            const tid = t?.id;
            if (!tid) return alert("Školení nemá id (znovu načti seznam).");

            const ok = confirm(`Opravdu smazat školení "${t?.name || "—"}"?`);
            if (!ok) return;

            try {
              await apiDeleteTraining(selectedEmployeeId, tid);
              if (editingTrainingId === tid) cancelEditTraining();
              await openDetail(selectedEmployeeId);
            } catch (err) {
              console.error(err);
              alert("Nepodařilo se smazat školení: " + (err?.message || err));
            }
          });

          btns.appendChild(plusBtn);
          btns.appendChild(resetBtn);
          btns.appendChild(editBtn);
          btns.appendChild(delBtn);

          title.appendChild(btns);
        }

        const dates = document.createElement("div");
        dates.className = "trainingDates";
        dates.textContent = `Od: ${t?.validFrom || "—"}  •  Do: ${t?.validTo || "—"}`;

        item.appendChild(title);
        item.appendChild(dates);

        if (canEditTraining() && t?.id && String(t.id) === String(editingTrainingId)) {
          const box = document.createElement("div");
          box.className = "editBox";

          const col1 = document.createElement("div");
          col1.className = "col";
          const l1 = document.createElement("div");
          l1.className = "miniLabel";
          l1.textContent = "Název školení";
          const i1 = document.createElement("input");
          i1.type = "text";
          i1.value = editDraft.name;
          i1.addEventListener("input", () => editDraft.name = i1.value);
          col1.appendChild(l1); col1.appendChild(i1);

          const col2 = document.createElement("div");
          col2.className = "col";
          const l2 = document.createElement("div");
          l2.className = "miniLabel";
          l2.textContent = "Platí od";
          const i2 = document.createElement("input");
          i2.type = "date";
          i2.value = editDraft.validFrom;
          i2.addEventListener("input", () => editDraft.validFrom = i2.value);
          col2.appendChild(l2); col2.appendChild(i2);

          const col3 = document.createElement("div");
          col3.className = "col";
          const l3 = document.createElement("div");
          l3.className = "miniLabel";
          l3.textContent = "Platí do";
          const i3 = document.createElement("input");
          i3.type = "date";
          i3.value = editDraft.validTo;
          i3.addEventListener("input", () => editDraft.validTo = i3.value);
          col3.appendChild(l3); col3.appendChild(i3);

          const saveBtn = document.createElement("button");
          saveBtn.className = "primary";
          saveBtn.textContent = "Uložit";
          saveBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            saveEditTraining();
          });

          const cancelBtn = document.createElement("button");
          cancelBtn.textContent = "Zrušit";
          cancelBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            cancelEditTraining();
          });

          box.appendChild(col1);
          box.appendChild(col2);
          box.appendChild(col3);
          box.appendChild(saveBtn);
          box.appendChild(cancelBtn);

          item.appendChild(box);
        }

        dTrainings.appendChild(item);
      }
    }

    function applyFilter(list, q, mode, expDays) {
      const s = normalizeText(q).toLowerCase();
      const nowMode = mode || "all";
      const days = Math.max(0, Number(expDays || 30) || 30);

      return list.filter(e => {
        const name = displayName(e).toLowerCase();
        const email = (e?.email || "").toLowerCase();
        const company = (e?.company || "").toLowerCase();
        const position = (e?.position || "").toLowerCase();

        const matchesText = !s || name.includes(s) || email.includes(s) || company.includes(s) || position.includes(s);
        if (!matchesText) return false;

        const st = employeeStatus(e, days).status;
        if (nowMode === "all") return true;
        return st === nowMode;
      });
    }

    function renderTable() {
      const mode = elFilterMode.value || "all";
      const days = Math.max(0, Number(elExpDays.value || 30) || 30);

      const visible = applyFilter(employees, elQ.value, mode, days);
      elRows.innerHTML = "";

      for (const e of visible) {
        const tr = document.createElement("tr");
        tr.addEventListener("click", () => openDetail(e.id));

        const tdName = document.createElement("td");
        tdName.textContent = displayName(e);

        const tdEmail = document.createElement("td");
        tdEmail.textContent = e?.email || "—";

        const tdCompany = document.createElement("td");
        tdCompany.textContent = e?.company || "—";

        const tdPos = document.createElement("td");
        tdPos.textContent = e?.position || "—";

        const tdSt = document.createElement("td");
        const st = employeeStatus(e, days);

        const wrap = document.createElement("span");
        wrap.className = "st";

        const dot = document.createElement("span");
        dot.className = "dot " + (st.status === "expired" ? "bad" : st.status === "expiring" ? "warn" : "ok");

        const txt = document.createElement("span");
        if (st.status === "expired") txt.textContent = "Propadlé";
        else if (st.status === "expiring") txt.textContent = `Končí do ${days} dní`;
        else txt.textContent = "OK";

        wrap.appendChild(dot);
        wrap.appendChild(txt);
        tdSt.appendChild(wrap);

        tr.appendChild(tdName);
        tr.appendChild(tdEmail);
        tr.appendChild(tdCompany);
        tr.appendChild(tdPos);
        tr.appendChild(tdSt);

        elRows.appendChild(tr);
      }

      elStatusText.textContent = `Načteno: ${visible.length} záznamů. Filtr: ${mode === "all" ? "Všichni" : (mode === "expired" ? "Propadlé" : mode === "expiring" ? "Končí brzy" : "OK")} • Končí brzy: ${days} dní`;
    }

    async function loadList() {
      elOkBadge.hidden = true;
      elStatusText.textContent = "Načítám…";

      try {
        employees = await apiList();
        renderTable();
        elOkBadge.hidden = false;
      } catch (err) {
        console.error(err);
        elStatusText.textContent = "Nepodařilo se načíst /api/employees. Je backend spuštěný a route existuje?";
      }
    }

    function openDetailModal() {
      detailBack.style.display = "flex";
      detailBack.setAttribute("aria-hidden", "false");
    }
    function closeDetailModal() {
      detailBack.style.display = "none";
      detailBack.setAttribute("aria-hidden", "true");
      selectedEmployeeId = null;
      cancelEditTraining();
    }

    async function openDetail(id) {
      selectedEmployeeId = id;
      openDetailModal();

      elDetailTitle.textContent = "Detail – načítám…";
      dName.textContent = dEmail.textContent = dCompany.textContent = dPosition.textContent = dId.textContent = dUpdatedAt.textContent = "—";
      dTrainCount.textContent = "0";
      dTrainings.innerHTML = "";

      const allow = canEditTraining();
      addTrainingBox.hidden = !allow;
      btnSaveTraining.disabled = !allow;

      try {
        const e = await apiDetail(id);

        elDetailTitle.textContent = `Detail – ${displayName(e)}`;
        dName.textContent = displayName(e);
        dEmail.textContent = e?.email || "—";
        dCompany.textContent = e?.company || "—";
        dPosition.textContent = e?.position || "—";
        dId.textContent = e?.id || "—";
        dUpdatedAt.textContent = fmtDate(e?.updatedAt);

        renderTrainings(e?.trainings);

        tName.value = "";
        tFrom.value = "";
        tTo.value = "";
      } catch (err) {
        console.error(err);
        elDetailTitle.textContent = "Detail – chyba načítání";
        const div = document.createElement("div");
        div.className = "trainingItem";
        div.style.color = "rgba(232,238,255,.55)";
        div.textContent = "Nepodařilo se načíst detail.";
        dTrainings.appendChild(div);
      }
    }

    async function saveTraining() {
      if (!selectedEmployeeId) return;
      if (!canEditTraining()) {
        alert("Tvoje role nemůže přidávat školení.");
        return;
      }

      const name = normalizeText(tName.value);
      const validFrom = normalizeText(tFrom.value);
      const validTo = normalizeText(tTo.value);

      if (!name || !validFrom || !validTo) {
        alert("Vyplň název, platí od a platí do.");
        return;
      }
      if (validTo < validFrom) {
        alert("Datum 'platí do' musí být později než 'platí od'.");
        return;
      }

      btnSaveTraining.disabled = true;
      btnSaveTraining.textContent = "Ukládám…";

      try {
        await apiAddTraining(selectedEmployeeId, { name, validFrom, validTo });
        await openDetail(selectedEmployeeId);
      } catch (err) {
        console.error(err);
        alert("Nepodařilo se uložit školení: " + (err?.message || err));
      } finally {
        btnSaveTraining.textContent = "Uložit školení";
        btnSaveTraining.disabled = !canEditTraining();
      }
    }

    // Role modal helpers
    function openRoleModal() {
      roleSelect.value = role;
      roleBack.style.display = "flex";
      roleBack.setAttribute("aria-hidden", "false");
    }
    function closeRoleModal() {
      roleBack.style.display = "none";
      roleBack.setAttribute("aria-hidden", "true");
    }

    async function applyRole() {
      role = roleSelect.value || "hr";
      localStorage.setItem(LS_ROLE, role);
      applyRoleUI();
      closeRoleModal();

      await loadList();
      if (selectedEmployeeId) await openDetail(selectedEmployeeId);
    }

    // ✅ PROKLIK z dashboardu: #emp=ID
    function getEmpIdFromHash() {
      const hash = (window.location.hash || "").replace(/^#/, "");
      const params = new URLSearchParams(hash);
      const empId = params.get("emp");
      return empId ? String(empId) : null;
    }

    function clearHash() {
      history.replaceState(null, "", window.location.pathname + window.location.search);
    }

    async function openEmpFromHashIfAny() {
      const empId = getEmpIdFromHash();
      if (!empId) return;
      await openDetail(empId);
      clearHash();
    }

    // events
    elBtnLoad.addEventListener("click", loadList);
    elQ.addEventListener("input", renderTable);
    elFilterMode.addEventListener("change", renderTable);
    elExpDays.addEventListener("input", renderTable);

    elBtnChangeRole.addEventListener("click", openRoleModal);
    btnRoleClose.addEventListener("click", closeRoleModal);
    btnRoleCancel.addEventListener("click", closeRoleModal);
    btnRoleApply.addEventListener("click", applyRole);
    roleBack.addEventListener("click", (e) => { if (e.target === roleBack) closeRoleModal(); });

    btnDetailClose.addEventListener("click", closeDetailModal);
    btnDetailClose2.addEventListener("click", closeDetailModal);
    detailBack.addEventListener("click", (e) => { if (e.target === detailBack) closeDetailModal(); });

    btnSaveTraining.addEventListener("click", saveTraining);

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        if (roleBack.style.display === "flex") closeRoleModal();
        if (detailBack.style.display === "flex") closeDetailModal();
      }
    });

    // start
    (async () => {
      applyRoleUI();
      await loadList();
      await openEmpFromHashIfAny();
    })();
  </script>
</body>
</html>
