<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Detail pracovníka – WORKACCESS</title>
  <link rel="icon" href="data:," />

  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #f8fafc;
      margin: 0;
      padding: 24px;
      color: #0f172a;
    }

    .container { max-width: 1100px; margin: 0 auto; }

    a { color: #0b5d7d; text-decoration: none; }
    a:hover { text-decoration: underline; }

    .topbar {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    .pill {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #fff;
      font-size: 14px;
    }

    .card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .muted { color: #6b7280; font-size: 14px; }

    .grid {
      display: grid;
      grid-template-columns: 220px 1fr;
      gap: 10px 14px;
      margin-top: 12px;
    }

    .k { color: #6b7280; }
    .v { word-break: break-word; }

    table { width: 100%; border-collapse: collapse; }
    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid #eef2f7;
      text-align: left;
      vertical-align: top;
    }

    button, input, select {
      font-family: inherit;
      font-size: 14px;
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: #fff;
    }
    button:hover { background: #f1f5f9; cursor: pointer; }

    /* barvy řádků */
    .tr-ok td { background: #f0fdf4; }
    .tr-warn td { background: #fffbeb; }
    .tr-expired td { background: #fef2f2; }

    .btn-row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .btn-small { padding: 6px 10px; border-radius: 10px; }

    .errorBox {
      color:#991b1b;
      border: 1px solid #fecaca;
      background: #fff;
      border-radius: 12px;
      padding: 10px 12px;
    }

    #trainingsFilter button.active {
      background: #0b5d7d;
      color: #fff;
      border-color: #0b5d7d;
    }

    /* ===== Quick actions box ===== */
    .actionsRow {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #fff;
      font-size: 13px;
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      display: inline-block;
      background: #94a3b8;
    }
    .dot.ok { background: #22c55e; }
    .dot.warn { background: #f59e0b; }
    .dot.bad { background: #ef4444; }

    .btn-primary {
      background: #0b5d7d;
      color: #fff;
      border-color: #0b5d7d;
    }
    .btn-primary:hover { background: #094e68; }
    button:disabled { opacity: .6; cursor: not-allowed; }

    /* ===== edit box ===== */
    .formGrid {
      display: grid;
      grid-template-columns: 220px 1fr;
      gap: 10px 14px;
      margin-top: 12px;
      align-items: center;
    }
    .formGrid input { width: 100%; max-width: 460px; }

    /* ===== Obnova školení (inline editor) ===== */
    .tr-edit td { background: #f8fafc; }
    .inlineEdit {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    .inlineEdit input { padding: 6px 10px; }

    .monthsInput { width: 110px; }

    /* ===== Šablony box ===== */
    .tplTable td input { padding: 6px 10px; }
    .tplNameInput { width: 320px; max-width: 100%; }
    .tplMonthsInput { width: 110px; }
  </style>
</head>

<body>
<div class="container">

  <div class="topbar">
    <a href="/employees.html">← Zpět</a>
    <span class="pill">Role: <strong id="roleLabel">—</strong></span>
    <span class="pill">ID: <code id="empId">—</code></span>
  </div>

  <div id="stateLoading" class="card">Načítám…</div>
  <div id="stateError" class="card errorBox" style="display:none;"></div>

  <div id="card" class="card" style="display:none;">
    <h1 id="title" style="margin:0 0 6px 0;">Pracovník</h1>
    <div class="muted" id="modeLabel" style="margin-bottom:12px;">Read-only karta</div>

    <!-- ===== Základní údaje ===== -->
    <div class="card" style="margin-top:12px;">
      <div class="btn-row" style="justify-content:space-between;">
        <h2 style="margin:0;">Základní údaje</h2>

        <div class="btn-row">
          <button id="btnEditBasic" type="button" style="display:none;">Upravit</button>
          <button id="btnSaveBasic" type="button" class="btn-primary" style="display:none;">Uložit</button>
          <button id="btnCancelBasic" type="button" style="display:none;">Zrušit</button>
        </div>
      </div>

      <div id="basicView" class="grid"></div>

      <div id="basicEdit" class="formGrid" style="display:none;">
        <div class="k">Jméno</div>
        <div><input id="inFirstName" placeholder="Jméno"></div>

        <div class="k">Příjmení</div>
        <div><input id="inLastName" placeholder="Příjmení"></div>

        <div class="k">Firma</div>
        <div><input id="inCompany" placeholder="Firma"></div>

        <div class="k">Email</div>
        <div><input id="inEmail" placeholder="Email"></div>

        <div class="k">Pozice</div>
        <div><input id="inPosition" placeholder="Pozice"></div>
      </div>

      <div id="basicMsg" class="muted" style="margin-top:10px;"></div>
    </div>

    <!-- ===== Rychlé akce ===== -->
    <div id="actionsBox" class="card" style="margin-top:12px;">
      <h2 style="margin:0 0 10px 0;">Rychlé akce</h2>

      <div class="actionsRow" style="margin-bottom:10px;">
        <span class="badge">
          <span id="empStatusDot" class="dot"></span>
          Stav: <strong id="empStatusText">—</strong>
        </span>

        <span class="badge">
          Poslední načtení: <strong id="empLoadedAt">—</strong>
        </span>
      </div>

      <div class="actionsRow">
        <button id="btnRefresh" type="button">Obnovit data</button>
        <button id="btnCopyId" type="button">Zkopírovat ID</button>
        <button id="btnCopyEmail" type="button">Zkopírovat email</button>

        <button id="btnToggleActive" type="button" class="btn-primary" style="display:none;">
          Deaktivovat
        </button>
      </div>

      <div id="actionsMsg" class="muted" style="margin-top:10px;"></div>
    </div>

    <!-- ===== Šablony školení (jen HR/Manažer) ===== -->
    <div id="templatesBox" class="card" style="margin-top:12px; display:none;">
      <h2 style="margin:0 0 8px 0;">Šablony školení (pro firmu)</h2>
      <div class="muted" style="margin-bottom:10px;">
        Šablony se teď ukládají lokálně (localStorage) zvlášť pro každou firmu. Později to snadno přepojíme na API.
      </div>

      <div class="btn-row" style="margin-bottom:10px;">
        <input id="tplNewName" class="tplNameInput" placeholder="Název šablony (např. BOZP)">
        <input id="tplNewMonths" class="tplMonthsInput" type="number" min="1" step="1" placeholder="Měsíce">
        <button id="tplAddBtn" type="button" class="btn-primary">Přidat šablonu</button>
      </div>

      <div id="tplMsg" class="muted" style="margin-bottom:10px;"></div>

      <table id="tplTable" class="tplTable">
        <thead>
          <tr>
            <th>Název</th>
            <th>Výchozí platnost (měsíce)</th>
            <th>Akce</th>
          </tr>
        </thead>
        <tbody id="tplTbody"></tbody>
      </table>
    </div>

    <!-- ===== Školení ===== -->
    <div class="card" style="margin-top:12px;">
      <h2 style="margin:0 0 10px 0;">Školení a certifikace</h2>

      <!-- jen HR/Manažer -->
      <div id="trainingsForm" style="display:none; margin: 10px 0 12px 0;">
        <div class="muted" style="margin-bottom:8px;">Přidat školení (jen HR/Manažer)</div>

        <div class="btn-row">
          <select id="trTemplate">
            <option value="">— vyber šablonu (volitelné) —</option>
          </select>

          <input id="trName" placeholder="Název školení">
          <input id="trFrom" type="date">
          <input id="trTo" type="date">

          <input id="trMonths" class="monthsInput" type="number" min="1" step="1" placeholder="Měsíce">

          <button id="trTodayBtn" type="button">Dnes</button>
          <button id="trCalcBtn" type="button">Dopočítat do</button>

          <button id="trAddBtn">Přidat</button>
        </div>

        <div class="muted" style="margin-top:6px;">
          Tip: Vyber šablonu → klikni „Dnes“ → zadej měsíce → „Dopočítat do“ → „Přidat“.
        </div>

        <div id="trMsg" class="muted" style="margin-top:8px;"></div>
      </div>

      <div id="trainingsFilter" style="display:none; margin: 10px 0 12px 0;" class="btn-row">
        <button type="button" data-filter="all" class="active">Vše</button>
        <button type="button" data-filter="ok">Platné</button>
        <button type="button" data-filter="warn">Brzy expiruje</button>
        <button type="button" data-filter="expired">Expir.</button>
      </div>

      <div id="trainingsSummary" class="muted" style="display:none; margin: 0 0 10px 0;">
        Celkem: <strong id="sumAll">0</strong> ·
        Platné: <strong id="sumOk">0</strong> ·
        Brzy: <strong id="sumWarn">0</strong> ·
        Expir.: <strong id="sumExpired">0</strong>
      </div>

      <div id="trainingsEmpty" class="muted" style="display:none;">Zatím žádné školení.</div>

      <table id="trainingsTable" style="display:none;">
        <thead>
          <tr>
            <th>Název</th>
            <th>Platí od</th>
            <th>Platí do</th>
            <th>Stav</th>
            <th>Akce</th>
          </tr>
        </thead>
        <tbody id="trainingsTbody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
  // ========= helpers =========
  function showError(msg) {
    document.getElementById("stateLoading").style.display = "none";
    const el = document.getElementById("stateError");
    el.style.display = "block";
    el.textContent = msg || "Chyba.";
  }

  function getRole() {
    return localStorage.getItem("demoRole") || "HR";
  }

  async function fetchJson(url, role) {
    const r = await fetch(url, { headers: { "x-role": role } });
    const text = await r.text();
    if (!r.ok) throw new Error(url + " → HTTP " + r.status + " → " + text);
    try { return JSON.parse(text); } catch { return text; }
  }

  async function putJson(url, role, bodyObj) {
    const r = await fetch(url, {
      method: "PUT",
      headers: { "Content-Type": "application/json", "x-role": role },
      body: JSON.stringify(bodyObj),
    });
    const text = await r.text();
    if (!r.ok) throw new Error("PUT " + url + " → HTTP " + r.status + " → " + text);
    try { return JSON.parse(text); } catch { return text; }
  }

  function toDateStr(x) {
    if (!x) return "—";
    const d = new Date(x);
    if (isNaN(d.getTime())) return String(x);
    return d.toISOString().slice(0,10);
  }

  function daysUntil(dateStr) {
    if (!dateStr) return null;
    const d = new Date(dateStr);
    if (isNaN(d.getTime())) return null;
    const today = new Date(); today.setHours(0,0,0,0);
    d.setHours(0,0,0,0);
    return Math.round((d - today) / 86400000);
  }

  function statusFor(t) {
    const d = daysUntil(t && t.validTo);
    if (d === null) return "Platné";
    if (d < 0) {
      const n = Math.abs(d);
      return `Expir. (před ${n} ${n === 1 ? "dnem" : n <= 4 ? "dny" : "dní"})`;
    }
    if (d <= 30) {
      return `Brzy expiruje (za ${d} ${d === 1 ? "den" : d <= 4 ? "dny" : "dní"})`;
    }
    return "Platné";
  }

  function typeForStatus(st) {
    if (String(st).startsWith("Expir.")) return "expired";
    if (String(st).startsWith("Brzy expiruje")) return "warn";
    return "ok";
  }

  function nowTimeStr() {
    const d = new Date();
    const hh = String(d.getHours()).padStart(2, "0");
    const mm = String(d.getMinutes()).padStart(2, "0");
    const ss = String(d.getSeconds()).padStart(2, "0");
    return `${hh}:${mm}:${ss}`;
  }

  function setStatusUI(kind, text) {
    const dot = document.getElementById("empStatusDot");
    const tx = document.getElementById("empStatusText");
    if (!dot || !tx) return;
    dot.classList.remove("ok", "warn", "bad");
    if (kind) dot.classList.add(kind);
    tx.textContent = text || "—";
  }

  function readActiveState(emp) {
    if (!emp || typeof emp !== "object") return { known: false };
    if (typeof emp.active === "boolean") return { known: true, key: "active", value: emp.active };
    if (typeof emp.isActive === "boolean") return { known: true, key: "isActive", value: emp.isActive };
    if (typeof emp.is_active === "boolean") return { known: true, key: "is_active", value: emp.is_active };
    if (typeof emp.enabled === "boolean") return { known: true, key: "enabled", value: emp.enabled };
    if (typeof emp.archived === "boolean") return { known: true, key: "archived", value: !emp.archived };
    if (typeof emp.status === "string") {
      const s = emp.status.trim().toLowerCase();
      if (["active","aktivni","aktivní","enabled"].includes(s)) return { known: true, key: "status", value: true };
      if (["inactive","neaktivni","neaktivní","disabled","archived"].includes(s)) return { known: true, key: "status", value: false };
    }
    if (typeof emp.state === "string") {
      const s = emp.state.trim().toLowerCase();
      if (["active","aktivni","aktivní","enabled"].includes(s)) return { known: true, key: "state", value: true };
      if (["inactive","neaktivni","neaktivní","disabled","archived"].includes(s)) return { known: true, key: "state", value: false };
    }
    return { known: false };
  }

  function writeActiveState(emp, newBool) {
    const cur = readActiveState(emp);
    if (!cur.known) return null;
    if (cur.key === "active") return { ...emp, active: !!newBool };
    if (cur.key === "isActive") return { ...emp, isActive: !!newBool };
    if (cur.key === "is_active") return { ...emp, is_active: !!newBool };
    if (cur.key === "enabled") return { ...emp, enabled: !!newBool };
    if (cur.key === "archived") return { ...emp, archived: !newBool };
    if (cur.key === "status") return { ...emp, status: newBool ? "active" : "inactive" };
    if (cur.key === "state") return { ...emp, state: newBool ? "active" : "inactive" };
    return null;
  }

  async function copyToClipboard(text) {
    if (!text) return false;
    try {
      await navigator.clipboard.writeText(String(text));
      return true;
    } catch {
      try {
        const ta = document.createElement("textarea");
        ta.value = String(text);
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        return true;
      } catch {
        return false;
      }
    }
  }

  function pick(obj, keys, fallback = "") {
    for (const k of keys) {
      if (obj && obj[k] !== undefined && obj[k] !== null && String(obj[k]).trim() !== "") return obj[k];
    }
    return fallback;
  }

  function renderBasicView(emp) {
    const view = document.getElementById("basicView");
    view.innerHTML = "";

    const email = pick(emp, ["email", "mail", "emailAddress"], "—");
    const position = pick(emp, ["position", "jobTitle", "roleTitle"], "—");
    const company = pick(emp, ["company"], "—");
    const firstName = pick(emp, ["firstName"], "—");
    const lastName = pick(emp, ["lastName"], "—");

    const rows = [
      ["Jméno", firstName],
      ["Příjmení", lastName],
      ["Firma", company],
      ["Email", email],
      ["Pozice", position]
    ];

    rows.forEach(([k,v]) => {
      const dk = document.createElement("div"); dk.className = "k"; dk.textContent = k;
      const dv = document.createElement("div"); dv.className = "v"; dv.textContent = v || "—";
      view.appendChild(dk); view.appendChild(dv);
    });
  }

  function fillBasicEdit(emp) {
    document.getElementById("inFirstName").value = pick(emp, ["firstName"], "");
    document.getElementById("inLastName").value = pick(emp, ["lastName"], "");
    document.getElementById("inCompany").value = pick(emp, ["company"], "");
    document.getElementById("inEmail").value = pick(emp, ["email", "mail", "emailAddress"], "");
    document.getElementById("inPosition").value = pick(emp, ["position", "jobTitle", "roleTitle"], "");
  }

  function applyBasicEditToEmp(emp) {
    return {
      ...emp,
      firstName: document.getElementById("inFirstName").value.trim() || emp.firstName,
      lastName: document.getElementById("inLastName").value.trim() || emp.lastName,
      company: document.getElementById("inCompany").value.trim() || emp.company,
      email: document.getElementById("inEmail").value.trim() || emp.email,
      position: document.getElementById("inPosition").value.trim() || emp.position,
    };
  }

  // ===== Datum helpery =====
  function isoToday() {
    const d = new Date();
    d.setHours(0,0,0,0);
    return d.toISOString().slice(0,10);
  }

  function addMonthsISO(isoDate, months) {
    if (!isoDate || !months) return "";
    const m = Number(months);
    if (!Number.isFinite(m) || m <= 0) return "";

    const d = new Date(isoDate);
    if (isNaN(d.getTime())) return "";

    const day = d.getDate();
    d.setMonth(d.getMonth() + m);
    if (d.getDate() < day) d.setDate(0);

    return d.toISOString().slice(0,10);
  }

  // ===== Šablony: default (použije se, když firma nemá vlastní) =====
  const DEFAULT_TEMPLATES = [
    { id: "bozp", name: "BOZP", months: 24 },
    { id: "po", name: "Požární ochrana (PO)", months: 24 },
    { id: "pp", name: "První pomoc", months: 24 },
    { id: "vysky", name: "Práce ve výškách", months: 12 },
    { id: "vzv", name: "Manipulace s VZV (ještěrka)", months: 12 },
    { id: "elektro", name: "Obsluha elektrických zařízení", months: 24 },
  ];

  function slugify(s) {
    return String(s || "")
      .toLowerCase()
      .trim()
      .replace(/\s+/g, "_")
      .replace(/[^\wá-ž0-9_]/g, "");
  }

  function templatesStorageKey(company) {
    const c = (company && String(company).trim()) ? String(company).trim() : "default";
    return "wa_templates_" + slugify(c);
  }

  function loadTemplates(company) {
    const key = templatesStorageKey(company);
    const raw = localStorage.getItem(key);
    if (!raw) return DEFAULT_TEMPLATES.map(x => ({...x}));

    try {
      const arr = JSON.parse(raw);
      if (!Array.isArray(arr)) return DEFAULT_TEMPLATES.map(x => ({...x}));
      return arr
        .filter(x => x && typeof x === "object")
        .map(x => ({
          id: String(x.id || cryptoRandomId()),
          name: String(x.name || "").trim(),
          months: Number(x.months || 0) || 0,
        }))
        .filter(x => x.name);
    } catch {
      return DEFAULT_TEMPLATES.map(x => ({...x}));
    }
  }

  function saveTemplates(company, templates) {
    const key = templatesStorageKey(company);
    localStorage.setItem(key, JSON.stringify(templates));
  }

  function cryptoRandomId() {
    try {
      if (crypto && crypto.randomUUID) return crypto.randomUUID();
    } catch {}
    return "id_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
  }

  function fillTemplateSelect(selectEl, templates) {
    if (!selectEl) return;
    selectEl.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = "— vyber šablonu (volitelné) —";
    selectEl.appendChild(opt0);

    templates.forEach(t => {
      const opt = document.createElement("option");
      opt.value = t.id;
      opt.textContent = `${t.name} (typicky ${t.months || "?"} měs.)`;
      selectEl.appendChild(opt);
    });
  }

  // ========= main =========
  (async () => {
    try {
      const id = new URLSearchParams(location.search).get("id");
      if (!id) { showError("Chybí parametr ?id=..."); return; }
      document.getElementById("empId").textContent = id;

      const role = getRole();
      const me = await fetchJson("/api/me", role);
      document.getElementById("roleLabel").textContent = me.roleLabel || me.role || role;

      const roleRaw = String(me.role || me.roleLabel || "").trim().toLowerCase();
      const canEdit =
        roleRaw === "hr" ||
        roleRaw === "manažer" ||
        roleRaw === "manazer" ||
        roleRaw === "manager";

      const modeLabel = document.getElementById("modeLabel");
      if (modeLabel) modeLabel.textContent = canEdit ? "Edit režim (HR/Manažer)" : "Read-only karta";

      const emp = await fetchJson("/api/employees/" + encodeURIComponent(id), role);

      document.getElementById("stateLoading").style.display = "none";
      document.getElementById("card").style.display = "block";
      document.getElementById("title").textContent =
        [emp.firstName || "", emp.lastName || ""].join(" ").trim() || "Pracovník";

      // ===== Basic info box =====
      const btnEdit = document.getElementById("btnEditBasic");
      const btnSave = document.getElementById("btnSaveBasic");
      const btnCancel = document.getElementById("btnCancelBasic");
      const basicView = document.getElementById("basicView");
      const basicEdit = document.getElementById("basicEdit");
      const basicMsg = document.getElementById("basicMsg");

      renderBasicView(emp);

      if (canEdit) btnEdit.style.display = "inline-block";

      function setEditMode(on) {
        basicMsg.textContent = "";
        basicView.style.display = on ? "none" : "grid";
        basicEdit.style.display = on ? "grid" : "none";
        btnEdit.style.display = (!on && canEdit) ? "inline-block" : "none";
        btnSave.style.display = (on && canEdit) ? "inline-block" : "none";
        btnCancel.style.display = (on && canEdit) ? "inline-block" : "none";
      }

      btnEdit.addEventListener("click", () => { fillBasicEdit(emp); setEditMode(true); });
      btnCancel.addEventListener("click", () => setEditMode(false));

      btnSave.addEventListener("click", async () => {
        try {
          btnSave.disabled = true;
          basicMsg.textContent = "Ukládám…";
          const updatedEmp = applyBasicEditToEmp(emp);
          await putJson("/api/employees/" + encodeURIComponent(emp.id || id), role, updatedEmp);
          basicMsg.textContent = "Uloženo. Obnovuji…";
          setTimeout(() => location.reload(), 250);
        } catch (e) {
          basicMsg.textContent = (e && e.message) ? e.message : "Chyba při ukládání.";
          btnSave.disabled = false;
        }
      });

      // ===== Quick actions box =====
      const actionsMsg = document.getElementById("actionsMsg");
      document.getElementById("empLoadedAt").textContent = nowTimeStr();

      const activeInfo = readActiveState(emp);
      const btnToggle = document.getElementById("btnToggleActive");

      if (activeInfo.known) {
        setStatusUI(activeInfo.value ? "ok" : "bad", activeInfo.value ? "Aktivní" : "Neaktivní");
        btnToggle.style.display = canEdit ? "inline-block" : "none";
        btnToggle.textContent = activeInfo.value ? "Deaktivovat" : "Aktivovat";
      } else {
        setStatusUI(null, "Neznámý (API pole nenalezeno)");
        btnToggle.style.display = "none";
      }

      document.getElementById("btnRefresh").addEventListener("click", () => location.reload());

      document.getElementById("btnCopyId").addEventListener("click", async () => {
        const ok = await copyToClipboard(id);
        actionsMsg.textContent = ok ? "ID zkopírováno do schránky." : "Nepodařilo se zkopírovat ID.";
        setTimeout(() => actionsMsg.textContent = "", 1500);
      });

      document.getElementById("btnCopyEmail").addEventListener("click", async () => {
        const email = pick(emp, ["email", "mail", "emailAddress"], "");
        const ok = await copyToClipboard(email);
        actionsMsg.textContent = ok ? "Email zkopírován do schránky." : "Email není k dispozici / nelze kopírovat.";
        setTimeout(() => actionsMsg.textContent = "", 1500);
      });

      if (btnToggle && canEdit && activeInfo.known) {
        btnToggle.addEventListener("click", async () => {
          try {
            const nowActive = readActiveState(emp);
            const nextActive = !nowActive.value;
            const question = nextActive ? "Opravdu chcete zaměstnance aktivovat?" : "Opravdu chcete zaměstnance deaktivovat?";
            if (!confirm(question)) return;

            btnToggle.disabled = true;
            actionsMsg.textContent = "Ukládám změnu stavu…";

            const updated = writeActiveState(emp, nextActive);
            await putJson("/api/employees/" + encodeURIComponent(emp.id || id), role, updated);

            actionsMsg.textContent = "Uloženo. Obnovuji…";
            setTimeout(() => location.reload(), 250);
          } catch (e) {
            actionsMsg.textContent = (e && e.message) ? e.message : "Chyba při ukládání.";
            btnToggle.disabled = false;
          }
        });
      }

      // ===== Templates box (jen HR/Manažer) + napojení na přidání školení =====
      const company = pick(emp, ["company"], "default");
      let templates = loadTemplates(company);

      const templatesBox = document.getElementById("templatesBox");
      const tplTbody = document.getElementById("tplTbody");
      const tplMsg = document.getElementById("tplMsg");
      const tplNewName = document.getElementById("tplNewName");
      const tplNewMonths = document.getElementById("tplNewMonths");
      const tplAddBtn = document.getElementById("tplAddBtn");

      const selTpl = document.getElementById("trTemplate");
      const inName = document.getElementById("trName");
      const inFrom = document.getElementById("trFrom");
      const inTo = document.getElementById("trTo");
      const inMonths = document.getElementById("trMonths");
      const btnToday = document.getElementById("trTodayBtn");
      const btnCalc = document.getElementById("trCalcBtn");

      function refreshTemplateSelect() {
        fillTemplateSelect(selTpl, templates);
      }

      function renderTemplatesTable() {
        if (!tplTbody) return;
        tplTbody.innerHTML = "";

        if (!templates.length) {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 3;
          td.className = "muted";
          td.textContent = "Zatím žádné šablony. Přidej první nahoře.";
          tr.appendChild(td);
          tplTbody.appendChild(tr);
          return;
        }

        templates.forEach((t, idx) => {
          const tr = document.createElement("tr");

          const tdName = document.createElement("td");
          const inN = document.createElement("input");
          inN.className = "tplNameInput";
          inN.value = t.name || "";
          tdName.appendChild(inN);

          const tdMonths = document.createElement("td");
          const inM = document.createElement("input");
          inM.className = "tplMonthsInput";
          inM.type = "number";
          inM.min = "1";
          inM.step = "1";
          inM.value = String(t.months || "");
          tdMonths.appendChild(inM);

          const tdAct = document.createElement("td");

          const btnSave = document.createElement("button");
          btnSave.type = "button";
          btnSave.className = "btn-small btn-primary";
          btnSave.textContent = "Uložit";

          const btnDel = document.createElement("button");
          btnDel.type = "button";
          btnDel.className = "btn-small";
          btnDel.textContent = "Smazat";
          btnDel.style.marginLeft = "8px";

          btnSave.addEventListener("click", () => {
            const name = inN.value.trim();
            const months = Number(inM.value || 0);

            if (!name) { tplMsg.textContent = "Název šablony nesmí být prázdný."; return; }
            if (!Number.isFinite(months) || months <= 0) { tplMsg.textContent = "Měsíce musí být číslo větší než 0."; return; }

            templates[idx] = { ...templates[idx], name, months };
            saveTemplates(company, templates);
            tplMsg.textContent = "Šablona uložena.";
            refreshTemplateSelect();
            setTimeout(() => tplMsg.textContent = "", 1200);
          });

          btnDel.addEventListener("click", () => {
            if (!confirm("Opravdu smazat šablonu?")) return;
            templates = templates.filter((_, i) => i !== idx);
            saveTemplates(company, templates);
            tplMsg.textContent = "Šablona smazána.";
            renderTemplatesTable();
            refreshTemplateSelect();
            setTimeout(() => tplMsg.textContent = "", 1200);
          });

          tdAct.appendChild(btnSave);
          tdAct.appendChild(btnDel);

          tr.appendChild(tdName);
          tr.appendChild(tdMonths);
          tr.appendChild(tdAct);
          tplTbody.appendChild(tr);
        });
      }

      if (canEdit) {
        templatesBox.style.display = "block";
        tplMsg.textContent = `Firma: ${company} (klíč: ${templatesStorageKey(company)})`;
        setTimeout(() => tplMsg.textContent = "", 2000);

        renderTemplatesTable();
        refreshTemplateSelect();

        tplAddBtn.addEventListener("click", () => {
          const name = tplNewName.value.trim();
          const months = Number(tplNewMonths.value || 0);

          if (!name) { tplMsg.textContent = "Vyplň název šablony."; return; }
          if (!Number.isFinite(months) || months <= 0) { tplMsg.textContent = "Vyplň platnost v měsících (větší než 0)."; return; }

          // jednoduchá prevence duplicit názvů
          const exists = templates.some(x => String(x.name).trim().toLowerCase() === name.toLowerCase());
          if (exists) { tplMsg.textContent = "Šablona s tímto názvem už existuje. Změň název nebo ji uprav v seznamu."; return; }

          templates.push({ id: cryptoRandomId(), name, months });
          saveTemplates(company, templates);

          tplNewName.value = "";
          tplNewMonths.value = "";

          tplMsg.textContent = "Šablona přidána.";
          renderTemplatesTable();
          refreshTemplateSelect();
          setTimeout(() => tplMsg.textContent = "", 1200);
        });
      } else {
        // read-only uživatel: šablony box neukazujeme, ale dropdown se klidně může plnit defaulty
        refreshTemplateSelect();
      }

      // akce v přidání školení
      function calcTo() {
        const from = inFrom.value || "";
        const months = inMonths.value || "";
        const to = addMonthsISO(from, months);
        if (to) inTo.value = to;
      }

      if (selTpl) {
        selTpl.addEventListener("change", () => {
          const tplId = selTpl.value || "";
          const t = templates.find(x => x.id === tplId);

          if (t) {
            inName.value = t.name;
            inMonths.value = String(t.months || "");
            if (inFrom.value && inMonths.value) calcTo();
          }
        });
      }

      if (btnToday) {
        btnToday.addEventListener("click", () => {
          inFrom.value = isoToday();
          if (inMonths.value) calcTo();
        });
      }

      if (btnCalc) {
        btnCalc.addEventListener("click", () => calcTo());
      }

      // ===== Trainings list =====
      const trainingsForm = document.getElementById("trainingsForm");
      trainingsForm.style.display = canEdit ? "block" : "none";

      const trainings = Array.isArray(emp.trainings) ? emp.trainings : [];
      trainings.sort((a,b) => {
        const ta = a && a.validTo ? new Date(a.validTo).getTime() : Number.POSITIVE_INFINITY;
        const tb = b && b.validTo ? new Date(b.validTo).getTime() : Number.POSITIVE_INFINITY;
        return ta - tb;
      });

      const emptyEl = document.getElementById("trainingsEmpty");
      const tableEl = document.getElementById("trainingsTable");
      const tbody = document.getElementById("trainingsTbody");
      const filterEl = document.getElementById("trainingsFilter");
      const summaryEl = document.getElementById("trainingsSummary");

      tbody.innerHTML = "";

      if (!trainings.length) {
        emptyEl.style.display = "block";
        tableEl.style.display = "none";
        filterEl.style.display = "none";
        summaryEl.style.display = "none";
      } else {
        emptyEl.style.display = "none";
        tableEl.style.display = "table";
        filterEl.style.display = "flex";
        summaryEl.style.display = "block";

        const counts = { all: trainings.length, ok: 0, warn: 0, expired: 0 };

        trainings.forEach((t, idx) => {
          const st = statusFor(t);
          const type = typeForStatus(st);
          counts[type]++;

          const tr = document.createElement("tr");
          tr.dataset.type = type;
          tr.className = "tr-" + type;

          const td1 = document.createElement("td"); td1.textContent = t.name || "—";
          const td2 = document.createElement("td"); td2.textContent = toDateStr(t.validFrom);
          const td3 = document.createElement("td"); td3.textContent = toDateStr(t.validTo);
          const td4 = document.createElement("td"); td4.textContent = st;
          const td5 = document.createElement("td");

          function closeAnyEditors() {
            tbody.querySelectorAll("tr.tr-edit").forEach(x => x.remove());
          }

          if (canEdit) {
            const btnDel = document.createElement("button");
            btnDel.textContent = "Smazat";
            btnDel.className = "btn-small";
            btnDel.addEventListener("click", async () => {
              if (!confirm("Opravdu smazat školení?")) return;

              const next = trainings.filter((_, i) => i !== idx);

              await putJson("/api/employees/" + encodeURIComponent(emp.id || id), role, {
                ...emp,
                trainings: next,
              });

              location.reload();
            });

            const btnRenew = document.createElement("button");
            btnRenew.textContent = "Obnovit";
            btnRenew.className = "btn-small";
            btnRenew.style.marginLeft = "8px";

            btnRenew.addEventListener("click", () => {
              closeAnyEditors();

              const trEdit = document.createElement("tr");
              trEdit.className = "tr-edit";

              const td = document.createElement("td");
              td.colSpan = 5;

              const wrap = document.createElement("div");
              wrap.className = "inlineEdit";

              const inFrom2 = document.createElement("input");
              inFrom2.type = "date";
              inFrom2.value = (t.validFrom ? toDateStr(t.validFrom) : "");

              const inTo2 = document.createElement("input");
              inTo2.type = "date";
              inTo2.value = (t.validTo ? toDateStr(t.validTo) : "");

              const btnSave2 = document.createElement("button");
              btnSave2.textContent = "Uložit";
              btnSave2.className = "btn-primary";

              const btnCancel2 = document.createElement("button");
              btnCancel2.textContent = "Zrušit";

              const msg2 = document.createElement("span");
              msg2.className = "muted";
              msg2.style.marginLeft = "6px";

              btnCancel2.addEventListener("click", () => trEdit.remove());

              btnSave2.addEventListener("click", async () => {
                try {
                  const newFrom = inFrom2.value || null;
                  const newTo = inTo2.value || null;

                  if (!newTo) { msg2.textContent = "Vyplň prosím datum 'Platí do'."; return; }

                  msg2.textContent = "Ukládám…";
                  btnSave2.disabled = true;

                  const next = trainings.map((x, i) => {
                    if (i !== idx) return x;
                    return { ...x, validFrom: newFrom, validTo: newTo };
                  });

                  await putJson("/api/employees/" + encodeURIComponent(emp.id || id), role, {
                    ...emp,
                    trainings: next,
                  });

                  msg2.textContent = "Uloženo. Obnovuji…";
                  setTimeout(() => location.reload(), 250);
                } catch (e) {
                  msg2.textContent = (e && e.message) ? e.message : "Chyba při ukládání.";
                  btnSave2.disabled = false;
                }
              });

              wrap.appendChild(document.createTextNode("Nové datum:"));
              wrap.appendChild(inFrom2);
              wrap.appendChild(inTo2);
              wrap.appendChild(btnSave2);
              wrap.appendChild(btnCancel2);
              wrap.appendChild(msg2);

              td.appendChild(wrap);
              trEdit.appendChild(td);

              tr.after(trEdit);
            });

            td5.appendChild(btnDel);
            td5.appendChild(btnRenew);
          } else {
            td5.textContent = "—";
          }

          tr.appendChild(td1);
          tr.appendChild(td2);
          tr.appendChild(td3);
          tr.appendChild(td4);
          tr.appendChild(td5);
          tbody.appendChild(tr);
        });

        document.getElementById("sumAll").textContent = counts.all;
        document.getElementById("sumOk").textContent = counts.ok;
        document.getElementById("sumWarn").textContent = counts.warn;
        document.getElementById("sumExpired").textContent = counts.expired;

        let currentFilter = "all";
        function applyFilter() {
          tbody.querySelectorAll("tr").forEach(tr => {
            if (tr.classList.contains("tr-edit")) return;
            const type = tr.dataset.type || "ok";
            tr.style.display = (currentFilter === "all" || currentFilter === type) ? "" : "none";
          });
        }

        filterEl.querySelectorAll("button[data-filter]").forEach(b => {
          b.addEventListener("click", () => {
            currentFilter = b.dataset.filter || "all";
            filterEl.querySelectorAll("button").forEach(x => x.classList.remove("active"));
            b.classList.add("active");
            applyFilter();
          });
        });

        applyFilter();
      }

      // add training
      const btnAdd = document.getElementById("trAddBtn");
      const trMsg = document.getElementById("trMsg");

      if (canEdit && btnAdd) {
        btnAdd.addEventListener("click", async () => {
          try {
            const name = document.getElementById("trName").value.trim();
            const validFrom = document.getElementById("trFrom").value || null;
            const validTo = document.getElementById("trTo").value || null;

            if (!name) { trMsg.textContent = "Vyplň název školení."; return; }
            if (!validTo) { trMsg.textContent = "Vyplň datum 'Platí do'."; return; }

            const next = Array.isArray(emp.trainings) ? [...emp.trainings] : [];
            next.push({ name, validFrom, validTo });

            await putJson("/api/employees/" + encodeURIComponent(emp.id || id), role, {
              ...emp,
              trainings: next,
            });

            trMsg.textContent = "Uloženo. Obnovuji…";
            setTimeout(() => location.reload(), 250);
          } catch (e) {
            trMsg.textContent = e && e.message ? e.message : "Chyba při ukládání.";
          }
        });
      }
    } catch (e) {
      showError(e && e.message ? e.message : "Chyba.");
    }
  })();
</script>
</body>
</html>
