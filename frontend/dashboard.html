<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Workaccess – Dashboard</title>
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div id="wa-nav"></div>

      <div class="section">
        <h1 style="font-size:18px; margin:0;">Dashboard – expirace školení</h1>
        <div class="small">GET <code>/api/reports/trainings</code> • Audit v2: filtry + stránkování + export</div>
      </div>

      <div class="section" style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;">
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <label class="small" for="days">Dní dopředu:</label>
          <input id="days" type="number" min="1" max="365" value="30" style="width:90px;" />
          <button class="waBtn--primary" id="btnLoad">Načíst</button>
        </div>

        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <span class="small">Audit:</span>
          <span class="pill" id="auditRolePill">—</span>
          <button id="btnAudit">Načíst audit</button>
        </div>
      </div>

      <!-- audit filtry -->
      <div class="section" id="auditFilters" style="display:none; border-top:1px solid var(--border); padding-top:12px;">
        <div class="small" style="margin-bottom:8px;">Filtry auditu (v2)</div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
          <label class="small" for="audLimit">Limit:</label>
          <input id="audLimit" type="number" min="1" max="200" value="20" style="width:90px;" />

          <label class="small" for="audActor">Actor role:</label>
          <select id="audActor" style="min-width:160px;">
            <option value="">(vše)</option>
            <option value="hr">hr</option>
            <option value="manager">manager</option>
            <option value="security">security</option>
            <option value="external">external</option>
          </select>

          <label class="small" for="audAction">Action (prefix):</label>
          <input id="audAction" type="text" placeholder="např. employee." style="min-width:220px;" />

          <label class="small" for="audEntityType">Entity type:</label>
          <input id="audEntityType" type="text" placeholder="employee / training / item" style="min-width:190px;" />

          <label class="small" for="audEntityId">Entity id:</label>
          <input id="audEntityId" type="text" placeholder="id…" style="min-width:190px;" />
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px;">
          <button class="waBtn--primary" id="btnAuditReload">Filtrovat</button>
          <button id="btnAuditMore" disabled>Načíst další</button>
          <button id="btnAuditExport">Export CSV</button>
          <span class="small" id="audStatus" style="opacity:0.8;"></span>
        </div>
      </div>

      <div class="section small" id="metaLine"></div>

      <div class="section" style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
        <div class="card" style="padding:12px;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <strong>Propadlé</strong>
            <span class="pill" id="cntExpired">0</span>
          </div>
          <div id="boxExpired" class="small" style="margin-top:10px;"></div>
        </div>

        <div class="card" style="padding:12px;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <strong>Končí brzy</strong>
            <span class="pill" id="cntSoon">0</span>
          </div>
          <div id="boxSoon" class="small" style="margin-top:10px;"></div>
        </div>

        <div class="card" style="padding:12px;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <strong>Audit (poslední změny)</strong>
            <span class="pill" id="cntAudit">0</span>
          </div>
          <div id="boxAudit" class="small" style="margin-top:10px;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- DŮLEŽITÉ pořadí: config -> nav -> api -->
  <script src="./js/wa_config.js"></script>
  <script src="./js/wa_nav.js"></script>
  <script src="./api.js"></script>

  <script>
    WA_NAV.renderNav("dashboard");

    const elDays = document.getElementById("days");
    const elBtnLoad = document.getElementById("btnLoad");
    const elBtnAudit = document.getElementById("btnAudit");
    const elMetaLine = document.getElementById("metaLine");

    const elAuditRolePill = document.getElementById("auditRolePill");

    const elCntExpired = document.getElementById("cntExpired");
    const elCntSoon = document.getElementById("cntSoon");
    const elCntAudit = document.getElementById("cntAudit");

    const elBoxExpired = document.getElementById("boxExpired");
    const elBoxSoon = document.getElementById("boxSoon");
    const elBoxAudit = document.getElementById("boxAudit");

    // audit controls
    const elAuditFilters = document.getElementById("auditFilters");
    const elAudLimit = document.getElementById("audLimit");
    const elAudActor = document.getElementById("audActor");
    const elAudAction = document.getElementById("audAction");
    const elAudEntityType = document.getElementById("audEntityType");
    const elAudEntityId = document.getElementById("audEntityId");

    const elBtnAuditReload = document.getElementById("btnAuditReload");
    const elBtnAuditMore = document.getElementById("btnAuditMore");
    const elBtnAuditExport = document.getElementById("btnAuditExport");
    const elAudStatus = document.getElementById("audStatus");

    let AUDIT_NEXT_CURSOR = null;
    let AUDIT_LAST_PARAMS = null;
    let AUDIT_ITEMS = [];

    function esc(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function roleLabel(roleKey) {
      const map = { hr: "HR", manager: "Manažer", security: "Bezpečnost", external: "Externista" };
      return map[roleKey] || roleKey;
    }

    function setCounts(expired, soon, audit) {
      elCntExpired.textContent = String(expired);
      elCntSoon.textContent = String(soon);
      elCntAudit.textContent = String(audit);
    }

    // placeholder (expirace)
    function renderTrainingsStub(role) {
      elBoxExpired.innerHTML = `<div class="pill">role: ${esc(role)}</div>`;
      elBoxSoon.innerHTML = `Nic.`;
    }

    function buildAuditParams(includeCursor) {
      const limit = Math.max(1, Math.min(200, Number(elAudLimit.value || 20) || 20));
      const actorRole = (elAudActor.value || "").trim();
      const action = (elAudAction.value || "").trim();
      const entityType = (elAudEntityType.value || "").trim();
      const entityId = (elAudEntityId.value || "").trim();

      const params = { limit };
      if (actorRole) params.actorRole = actorRole;
      if (action) params.action = action;
      if (entityType) params.entityType = entityType;
      if (entityId) params.entityId = entityId;
      if (includeCursor && AUDIT_NEXT_CURSOR) params.cursor = AUDIT_NEXT_CURSOR;

      return params;
    }

    function renderAuditList(list) {
      elCntAudit.textContent = String(list.length);

      elBoxAudit.innerHTML = list.length
        ? list.slice(0, 50).map((x) => {
            const ts = esc(x.ts || "");
            const action = esc(x.action || "");
            const role = esc(x.actorRole || "");
            const entity = esc(x.entityType || "");
            const id = esc(x.entityId || "");
            return `
              <div style="padding:8px 0; border-top:1px solid var(--border);">
                <div>
                  <span class="pill">${ts}</span>
                  <span class="pill">${action}</span>
                  <span class="pill">role: ${role}</span>
                </div>
                <div class="small">Změna: ${entity}${id ? " • " + id : ""}</div>
              </div>
            `;
          }).join("")
        : "Nic.";
    }

    async function refreshMeAndUi() {
      const role = WA_NAV.getRole();
      elAuditRolePill.textContent = roleLabel(role);

      const me = await WA_API.getMe();
      const backendRole = me?.role || role;

      elMetaLine.textContent =
        `Dnes: ${new Date().toISOString().slice(0, 10)} • okno: ${Number(elDays.value || 30)} dní • role: ${roleLabel(backendRole)}`;

      const canAudit = backendRole !== "external";
      elBtnAudit.style.display = canAudit ? "" : "none";
      elAuditFilters.style.display = canAudit ? "" : "none";

      renderTrainingsStub(backendRole);
      setCounts(0, 0, 0);
      elBoxAudit.innerHTML = "—";
      elAudStatus.textContent = "";
      AUDIT_NEXT_CURSOR = null;
      AUDIT_LAST_PARAMS = null;
      AUDIT_ITEMS = [];
      elBtnAuditMore.disabled = true;
    }

    async function loadAuditFirstPage() {
      elBtnAudit.disabled = true;
      elBtnAuditReload.disabled = true;
      elBtnAuditMore.disabled = true;
      elBtnAuditExport.disabled = true;
      elAudStatus.textContent = "Načítám…";

      try {
        AUDIT_NEXT_CURSOR = null;
        AUDIT_ITEMS = [];

        const params = buildAuditParams(false);
        AUDIT_LAST_PARAMS = { ...params };

        const data = await WA_API.getAudit(params);
        const items = Array.isArray(data?.items) ? data.items : [];

        AUDIT_ITEMS = items;
        AUDIT_NEXT_CURSOR = data?.nextCursor || null;

        renderAuditList(AUDIT_ITEMS);

        elBtnAuditMore.disabled = !AUDIT_NEXT_CURSOR;
        elAudStatus.textContent = `Načteno: ${items.length}${AUDIT_NEXT_CURSOR ? " • další stránka k dispozici" : ""}`;
      } catch (e) {
        elBoxAudit.innerHTML = `<span class="pill">Chyba</span> ${esc(e?.message || e)}`;
        elCntAudit.textContent = "0";
        elAudStatus.textContent = "";
      } finally {
        elBtnAudit.disabled = false;
        elBtnAuditReload.disabled = false;
        elBtnAuditExport.disabled = false;
      }
    }

    async function loadAuditMore() {
      if (!AUDIT_NEXT_CURSOR || !AUDIT_LAST_PARAMS) return;

      elBtnAuditMore.disabled = true;
      elAudStatus.textContent = "Načítám další…";

      try {
        const params = { ...AUDIT_LAST_PARAMS, cursor: AUDIT_NEXT_CURSOR };
        const data = await WA_API.getAudit(params);
        const items = Array.isArray(data?.items) ? data.items : [];

        AUDIT_ITEMS = AUDIT_ITEMS.concat(items);
        AUDIT_NEXT_CURSOR = data?.nextCursor || null;

        renderAuditList(AUDIT_ITEMS);

        elBtnAuditMore.disabled = !AUDIT_NEXT_CURSOR;
        elAudStatus.textContent = `Celkem: ${AUDIT_ITEMS.length}${AUDIT_NEXT_CURSOR ? " • další stránka k dispozici" : ""}`;
      } catch (e) {
        elAudStatus.textContent = `Chyba: ${esc(e?.message || e)}`;
      }
    }

    async function exportAuditCsv() {
      if (!AUDIT_LAST_PARAMS) {
        // export bez filtrů → vezmeme aktuální vstupy
        AUDIT_LAST_PARAMS = buildAuditParams(false);
      }

      elBtnAuditExport.disabled = true;
      elAudStatus.textContent = "Generuji CSV…";

      try {
        const blob = await WA_API.fetchAuditCsv(AUDIT_LAST_PARAMS);

        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "audit.csv";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);

        elAudStatus.textContent = "CSV staženo.";
      } catch (e) {
        elAudStatus.textContent = `Chyba exportu: ${esc(e?.message || e)}`;
      } finally {
        elBtnAuditExport.disabled = false;
      }
    }

    elBtnLoad.addEventListener("click", refreshMeAndUi);

    elBtnAudit.addEventListener("click", loadAuditFirstPage);
    elBtnAuditReload.addEventListener("click", loadAuditFirstPage);
    elBtnAuditMore.addEventListener("click", loadAuditMore);
    elBtnAuditExport.addEventListener("click", exportAuditCsv);

    // init
    (async () => {
      try {
        await refreshMeAndUi();
      } catch (e) {
        console.error(e);
        alert("Nepodařilo se inicializovat dashboard. Je backend spuštěný na http://localhost:3000 ?");
      }
    })();
  </script>
</body>
</html>
